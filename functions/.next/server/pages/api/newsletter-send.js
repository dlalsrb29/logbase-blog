"use strict";(()=>{var e={};e.id=841,e.ids=[841],e.modules={145:e=>{e.exports=require("next/dist/compiled/next-server/pages-api.runtime.prod.js")},9648:e=>{e.exports=import("axios")},3292:e=>{e.exports=require("fs/promises")},1017:e=>{e.exports=require("path")},6249:(e,t)=>{Object.defineProperty(t,"l",{enumerable:!0,get:function(){return function e(t,s){return s in t?t[s]:"then"in t&&"function"==typeof t.then?t.then(t=>e(t,s)):"function"==typeof t&&"default"===s?t:void 0}}})},2629:(e,t,s)=>{s.a(e,async(e,n)=>{try{s.r(t),s.d(t,{config:()=>u,default:()=>i,routeModule:()=>E});var a=s(1802),o=s(7153),r=s(6249),l=s(9599),c=e([l]);l=(c.then?(await c)():c)[0];let i=(0,r.l)(l,"default"),u=(0,r.l)(l,"config"),E=new a.PagesAPIRouteModule({definition:{kind:o.x.PAGES_API,page:"/api/newsletter-send",pathname:"/api/newsletter-send",bundlePath:"",filename:""},userland:l});n()}catch(e){n(e)}})},9599:(e,t,s)=>{s.a(e,async(e,n)=>{try{s.r(t),s.d(t,{default:()=>E});var a=s(9648),o=s(3292),r=s(1017),l=s.n(r),c=e([a]);a=(c.then?(await c)():c)[0];let m=process.env.MAILERLITE_API_KEY||"",p="https://connect.mailerlite.com/api",d=()=>({Authorization:`Bearer ${m}`,"Content-Type":"application/json",Accept:"application/json"});async function i(e){try{let t=await a.default.post(`${p}/subscribers`,{email:e.email,fields:{name:e.name,company:e.company,phone:e.phone},status:"active"},{headers:d()});return console.log(`✅ [MAILERLITE] 구독자 동기화 성공: ${e.email}`),t.data.data}catch(t){throw console.error(`❌ [MAILERLITE] 구독자 동기화 실패 ${e.email}:`,t.response?.data||t.message),t}}async function u(e,t,s,n,o){try{let r={name:`Newsletter: ${e} - ${new Date().toISOString().slice(0,10)}`,type:"regular",emails:[{subject:e,from_name:t,from:s,content:n}]};console.log("\uD83D\uDCE7 [MAILERLITE] 캠페인 생성 중...");let l=(await a.default.post(`${p}/campaigns`,r,{headers:d()})).data.data.id;return console.log(`✅ [MAILERLITE] 캠페인 생성 완료. ID: ${l}`),console.log("\uD83D\uDE80 [MAILERLITE] 캠페인 발송 중..."),await a.default.post(`${p}/campaigns/${l}/schedule`,{delivery:"instant"},{headers:d()}),console.log("✅ [MAILERLITE] 캠페인 발송 완료!"),{campaignId:l,campaignName:r.name,recipientCount:o.length}}catch(e){throw console.error("❌ [MAILERLITE] 캠페인 생성/발송 실패:",e.response?.data||e.message),e}}async function E(e,t){if("POST"!==e.method)return t.status(405).json({message:"Method not allowed"});try{let s;let{filename:n,subject:a,fromName:r,fromEmail:c,recipients:E}=e.body;if(console.log("\uD83C\uDFAF [NEWSLETTER SEND] 요청 받음:",{filename:n,subject:a,fromName:r,fromEmail:c,recipientCount:E?.length}),!n||!a||!r||!c||!E||0===E.length)return t.status(400).json({success:!1,message:"필수 정보가 누락되었습니다. (filename, subject, fromName, fromEmail, recipients)"});let p="true"===process.env.NEWSLETTER_TEST_MODE;if(!m&&!p)return t.status(500).json({success:!1,message:"MailerLite API 키가 설정되지 않았습니다. 환경 변수를 확인해주세요."});let d=l().resolve(process.cwd(),`public/newsletters/${n}.html`);try{s=await (0,o.readFile)(d,"utf-8"),console.log("\uD83D\uDCC4 [NEWSLETTER SEND] HTML 파일 로드 완료")}catch(e){return t.status(404).json({success:!1,message:`뉴스레터 HTML 파일을 찾을 수 없습니다: ${n}.html`})}if(p)return console.log("\uD83E\uDDEA [TEST MODE] 뉴스레터 발송 시뮬레이션"),console.log("\uD83D\uDCE7 제목:",a),console.log("\uD83D\uDC64 발신자:",`${r} <${c}>`),console.log("\uD83D\uDC65 수신자 수:",E.length),console.log("\uD83D\uDCDD HTML 길이:",s.length),t.status(200).json({success:!0,message:`테스트 모드: ${E.length}명에게 "${a}" 뉴스레터 발송 시뮬레이션 완료`,campaignId:"test-campaign-"+Date.now(),testMode:!0});console.log("\uD83D\uDC65 [NEWSLETTER SEND] 구독자 동기화 시작...");let g=E.map(e=>i(e));try{await Promise.all(g),console.log(`✅ [NEWSLETTER SEND] ${E.length}명 구독자 동기화 완료`)}catch(e){console.warn("⚠️ [NEWSLETTER SEND] 일부 구독자 동기화 실패, 계속 진행...")}let D=await u(a,r,c,s,E),f={filename:n,subject:a,fromName:r,fromEmail:c,recipientCount:E.length,campaignId:D.campaignId,campaignName:D.campaignName,sentAt:new Date().toISOString(),status:"sent"};return console.log("\uD83C\uDF89 [NEWSLETTER SEND] 발송 완료!",f),t.status(200).json({success:!0,message:"뉴스레터가 성공적으로 발송되었습니다!",data:f})}catch(s){console.error("\uD83D\uDCA5 [NEWSLETTER SEND] 발송 실패:",s);let e=s instanceof Error?s.message:"알 수 없는 오류가 발생했습니다.";return t.status(500).json({success:!1,message:`뉴스레터 발송에 실패했습니다: ${e}`,error:void 0})}}n()}catch(e){n(e)}})},7153:(e,t)=>{var s;Object.defineProperty(t,"x",{enumerable:!0,get:function(){return s}}),function(e){e.PAGES="PAGES",e.PAGES_API="PAGES_API",e.APP_PAGE="APP_PAGE",e.APP_ROUTE="APP_ROUTE"}(s||(s={}))},1802:(e,t,s)=>{e.exports=s(145)}};var t=require("../../webpack-api-runtime.js");t.C(e);var s=t(t.s=2629);module.exports=s})();