# 🚀 Firebase Functions 배포 가이드

## 📁 **중요한 파일 구조**

```
logbase-blog/
├── functions/                    # Firebase Functions 소스
│   ├── index.js                 # 🔥 핵심 - Functions 엔트리포인트
│   ├── package.json             # Functions 의존성
│   ├── .next/                   # Next.js 빌드 결과물 (복사됨)
│   ├── src/                     # 소스코드 (복사됨)
│   ├── next.config.js           # Next.js 설정 (복사됨)
│   └── tsconfig.json            # TypeScript 설정 (복사됨)
├── src/                         # 원본 소스코드
├── next.config.js               # 🔥 핵심 - output: 'standalone'
├── firebase.json                # 🔥 핵심 - Firebase 설정
└── .next/                       # 빌드 결과물 (원본)
```

## 🔧 **빌드 프로세스**

### 1️⃣ **메인 빌드 (프로젝트 루트에서)**
```bash
cd C:\00.PROJECT\NEXTJS\logbase-blog
npm run build
```
- ✅ `output: 'standalone'` 설정으로 빌드
- ✅ `.next/standalone/` 디렉토리 생성됨

### 2️⃣ **Functions 디렉토리로 파일 복사**
```bash
# .next 디렉토리 복사
Remove-Item -Recurse -Force functions/.next -ErrorAction SilentlyContinue
Copy-Item -Recurse .next functions/

# 소스코드 복사
Remove-Item -Recurse -Force functions/src -ErrorAction SilentlyContinue
Copy-Item -Recurse src functions/

# 설정 파일 복사
Copy-Item next.config.js functions/ -Force
Copy-Item tsconfig.json functions/ -Force
```

### 3️⃣ **Functions 의존성 확인**
```bash
cd functions
npm install next  # Next.js 패키지 필수
cd ..
```

## 🔥 **핵심 설정 파일들**

### **1. `next.config.js`**
```javascript
const nextConfig = {
  output: 'standalone',  // 🔥 필수! Firebase Functions용
  eslint: { ignoreDuringBuilds: true },
  typescript: { ignoreBuildErrors: true }
};
```

### **2. `functions/index.js`**
```javascript
// 🔥 리전 설정 필수
exports.nextjsFunc = onRequest({
  region: 'asia-northeast3',  // 한국 리전
  timeoutSeconds: 540,
  memory: '2GiB'
}, async (req, res) => {
  // Next.js 앱 초기화 및 요청 처리
});
```

### **3. `firebase.json`**
```json
{
  "functions": [{
    "source": "functions",  // Functions 소스 위치
    "runtime": "nodejs20"
  }],
  "hosting": {
    "rewrites": [{
      "source": "**",
      "function": {
        "functionId": "nextjsFunc",
        "region": "asia-northeast3"  // 🔥 리전 일치 필수
      }
    }]
  }
}
```

## ⚠️ **배포시 주의사항**

### **DO ✅**
1. **빌드는 항상 프로젝트 루트에서**: `logbase-blog/`
2. **리전 일치**: `firebase.json`과 `functions/index.js` 모두 `asia-northeast3`
3. **파일 복사 순서**: 빌드 → 파일복사 → 배포
4. **next 패키지**: `functions/package.json`에 포함 필수
5. **standalone 모드**: `output: 'standalone'` 설정

### **DON'T ❌**
1. ~~`functions` 디렉토리에서 빌드하지 말 것~~
2. ~~리전 불일치 (us-central1 vs asia-northeast3)~~
3. ~~standalone 서버 직접 실행 (포트 충돌)~~
4. ~~`getRequestHandler()` 없이 배포~~

## 🚀 **배포 명령어 순서**

### **전체 배포 스크립트 (PowerShell)**
```powershell
# 1. 프로젝트 루트에서 빌드
cd C:\00.PROJECT\NEXTJS\logbase-blog
npm run build

# 2. 파일 복사
Remove-Item -Recurse -Force functions/.next -ErrorAction SilentlyContinue; Copy-Item -Recurse .next functions/
Remove-Item -Recurse -Force functions/src -ErrorAction SilentlyContinue; Copy-Item -Recurse src functions/
Copy-Item next.config.js functions/ -Force; Copy-Item tsconfig.json functions/ -Force

# 3. Functions 의존성 확인
cd functions; npm install next; cd ..

# 4. 배포
firebase deploy --only functions
```

### **단계별 실행**
```bash
# 1단계: 빌드
npm run build

# 2단계: 파일 복사
Remove-Item -Recurse -Force functions/.next -ErrorAction SilentlyContinue
Copy-Item -Recurse .next functions/
Remove-Item -Recurse -Force functions/src -ErrorAction SilentlyContinue  
Copy-Item -Recurse src functions/
Copy-Item next.config.js functions/ -Force
Copy-Item tsconfig.json functions/ -Force

# 3단계: 의존성 설치
cd functions
npm install next
cd ..

# 4단계: 배포
firebase deploy --only functions
```

## 🎯 **성공 지표**

### **배포 성공시 출력**
```
✅ functions[nextjsFunc(asia-northeast3)] Successful create operation.
✅ Function URL: https://asia-northeast3-logbase-blog-83db6.cloudfunctions.net/nextjsFunc
```

### **로그에서 확인해야 할 내용**
```
🔧 Next.js 앱 준비 중...
✅ Next.js 앱 초기화 완료
🔧 Next.js로 요청 전달
```

### **로그 확인 명령어**
```bash
firebase functions:log --only nextjsFunc
```

## 🐛 **트러블슈팅**

### **자주 발생하는 오류들**
1. **`req.on is not a function`**
   - 원인: standalone 서버 직접 실행
   - 해결: `getRequestHandler()` 사용

2. **`EADDRINUSE: address already in use`**
   - 원인: 포트 8080 충돌
   - 해결: standalone 서버 대신 Next.js 앱 객체 사용

3. **리전 불일치 오류**
   - 원인: `firebase.json`과 `functions/index.js` 리전 다름
   - 해결: 모두 `asia-northeast3`로 통일

4. **빌드 파일 없음**
   - 원인: 프로젝트 루트에서 빌드 안함
   - 해결: `logbase-blog/`에서 `npm run build`

## 📝 **체크리스트**

배포 전 확인사항:
- [ ] 프로젝트 루트에서 `npm run build` 실행
- [ ] `.next/standalone/` 디렉토리 존재 확인
- [ ] `functions/.next/` 복사 완료
- [ ] `functions/src/` 복사 완료
- [ ] `functions/next.config.js` 복사 완료
- [ ] `functions/package.json`에 `next` 패키지 포함
- [ ] `firebase.json`과 `functions/index.js` 리전 일치
- [ ] `firebase deploy --only functions` 실행

---

**마지막 성공 배포일**: 2025-07-28
**배포 환경**: Windows PowerShell
**리전**: asia-northeast3
**Next.js 버전**: 14.2.5
**Node.js 버전**: 20 